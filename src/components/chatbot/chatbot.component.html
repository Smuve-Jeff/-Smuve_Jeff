<!-- Backdrop -->
<div class="fixed inset-0 bg-black/60 z-40 animate-fade-in" (click)="onClose()"></div>

<!-- Panel -->
<div class="fixed inset-x-4 bottom-4 sm:inset-auto sm:right-4 sm:bottom-4 border-2 border-green-400/50 bg-black/90 backdrop-blur-lg p-4 w-full max-w-sm h-[70vh] flex flex-col z-50 animate-slide-up font-mono text-green-400">
  
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg">[[ S.M.U.V.E ]]</h2>
    <button (click)="onClose()" class="border border-green-400/50 px-2 hover:bg-green-400 hover:text-black transition-colors">
      [X]
    </button>
  </div>
  
  <div #chatHistory class="flex-grow overflow-y-auto pr-2 mb-4 border-b border-green-400/30 pb-2 space-y-3 chat-history">
    @for (message of messages(); track $index) {
      <div [class.text-right]="message.role === 'user'" [class.text-left]="message.role === 'model'">
        <div class="inline-block p-2 rounded-lg max-w-[85%]"
          [class.bg-green-700/50]="message.role === 'user'"
          [class.bg-green-900/50]="message.role === 'model'">
          <span class="text-xs text-green-300 mr-2">{{ message.role === 'user' ? 'YOU:' : 'S.M.U.V.E:' }}</span>
          <span>{{ message.content }}</span>
          @if (message.urls && message.urls.length > 0) {
            <div class="text-xs text-green-500 mt-2 border-t border-green-500/30 pt-1">
              <p class="font-bold">Sources:</p>
              @for (url of message.urls; track url.uri) {
                <a [href]="url.uri" target="_blank" rel="noopener noreferrer" class="block underline hover:text-green-300">
                  {{ url.title || url.uri }}
                </a>
              }
            </div>
          }
        </div>
      </div>
    }
    @if (isLoading()) {
      <div class="text-left">
        <div class="inline-block p-2 rounded-lg bg-green-900/50 max-w-[85%]">
          <span class="text-xs text-green-300 mr-2">S.M.U.V.E:</span>
          <span>Thinking...</span>
        </div>
      </div>
    } @else if (isSpeaking()) {
       <div class="text-left">
        <div class="inline-block p-2 rounded-lg bg-green-900/50 max-w-[85%] animate-pulse">
          <span class="text-xs text-green-300 mr-2">S.M.U.V.E:</span>
          <span>Speaking...</span>
        </div>
      </div>
    }
    @if (messages().length === 0 && !isLoading() && !isSpeaking() && isAiAvailable()) {
      <div class="text-center text-green-400/70 py-4">
        Hi! I'm S.M.U.V.E. How can I help you with your music today?
      </div>
    }
  </div>

  <div class="flex gap-2 mb-2">
    <button type="button" (click)="toggleDeepQuery()" 
      class="flex-grow p-2 border border-green-400/50 hover:bg-green-400 hover:text-black text-sm transition-colors"
      [class.bg-green-500]="isDeepQueryActive()"
      [class.text-black]="isDeepQueryActive()"
      [disabled]="isLoading() || isVoiceInputActive() || !isAiAvailable()">
      @if (isDeepQueryActive()) {
        <span>[ DEEP QUERY ACTIVE ]</span>
      } @else {
        <span>[ DEEP QUERY ]</span>
      }
    </button>
  </div>

  <form (submit)="sendMessage()" class="flex gap-2" [class.opacity-50]="!isAiAvailable()">
    <button type="button" (click)="toggleVoiceInput()" 
      class="p-2 border border-green-400/50 hover:bg-green-400 hover:text-black text-sm transition-colors flex items-center justify-center w-10 h-10"
      [class.bg-green-500]="isVoiceInputActive()"
      [class.text-black]="isVoiceInputActive()"
      [disabled]="isLoading() || isDeepQueryActive() || !isAiAvailable()">
      @if (isVoiceInputActive()) {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 animate-pulse">
          <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
          <path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 1 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" />
        </svg>
      } @else {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
          <path d="M12 21a2.25 2.25 0 0 0 2.25-2.25V15a.75.75 0 0 0-1.5 0v3.75c0 .414-.336.75-.75.75s-.75-.336-.75-.75V15a.75.75 0 0 0-1.5 0v3.75c0 .414-.336.75-.75.75s-.75-.336-.75-.75V15a.75.75 0 0 0-1.5 0v3.75A2.25 2.25 0 0 0 12 21Z" />
          <path d="M18.75 10.5a.75.75 0 0 0-1.5 0v1.5a6.75 6.75 0 0 1-13.5 0v-1.5a.75.75 0 0 0-1.5 0v1.5a8.25 8.25 0 1 0 16.5 0v-1.5A.75.75 0 0 0 18.75 10.5Z" />
        </svg>
      }
    </button>
    <input 
      type="text" 
      placeholder="Type your message..." 
      [value]="userMessage()"
      (input)="userMessage.set($event.target.value)"
      class="flex-grow bg-black border border-green-400/50 text-green-400 placeholder-green-400/50 px-2 py-1 text-sm focus:ring-green-500 focus:border-green-500"
      [disabled]="isLoading() || isVoiceInputActive() || !isAiAvailable()">
    <button 
      type="submit" 
      class="p-2 border border-green-400/50 hover:bg-green-400 hover:text-black text-sm"
      [disabled]="isLoading() || isVoiceInputActive() || !isAiAvailable()">
      [ SEND ]
    </button>
  </form>
</div>
